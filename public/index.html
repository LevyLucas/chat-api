<!DOCTYPE html>
<html lang="en" class="bg-transparent">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script defer src="https://cdn.tailwindcss.com"></script>
    <style>
      .fade-out {
        animation: fade 0.5s ease-in forwards;
      }

      @keyframes fade {
        to {
          opacity: 0;
          transform: translateY(-20px);
        }
      }
    </style>
  </head>

  <body class="overflow-hidden">
    <ul
      id="chat"
      class="flex flex-col-reverse gap-2 p-2 w-full max-h-screen"
    ></ul>

    <script type="module">
      const chat = document.getElementById("chat");
      const HISTORY_LIMIT = 50;

      const addMsg = ({ platform, user, text, color }) => {
        const li = document.createElement("li");

        li.className = "px-3 py-2 rounded-lg text-sm max-w-full break-words shadow-lg backdrop-blur-sm text-white border-l-4";
        li.style.background = "rgba(0, 0, 0, 0.6)";
        li.style.borderColor = platform === "twitch" ? "#9146FF" : "#FF0000";

        const usernameColor = platform === "twitch" && color ? color : "#FF4F4F";
        li.innerHTML = `<span style="color:${usernameColor}; text-shadow: 0 0 2px black, 0 0 2px black;" class="font-bold">${user}:</span> ${text}`;
        chat.prepend(li);

        setTimeout(() => li.classList.add("fade-out"), 24_000);
        setTimeout(() => li.remove(), 24_500);

        while (chat.children.length > HISTORY_LIMIT) chat.lastChild.remove();
      };

      let ws;

      const connect = () => {
        ws = new WebSocket(`ws://${location.host}`);

        ws.onopen = () => console.log("[WS] conectado");

        ws.onmessage = (ev) => {
          const payload = JSON.parse(ev.data);
          if (Array.isArray(payload)) {
            payload.forEach(addMsg);
          } else {
            addMsg(payload);
          }
        };

        ws.onclose = () => {
          console.warn("[WS] desconectado — tentando em 3 s…");
          setTimeout(connect, 3000);
        };

        ws.onerror = () => ws.close();
      };

      connect();
    </script>
  </body>
</html>
