<!DOCTYPE html>
<html lang="en" class="bg-transparent">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script defer src="https://cdn.tailwindcss.com"></script>
    <style>
      .fade-out {
        animation: fade 0.5s ease-in forwards;
      }
      @keyframes fade {
        to { opacity: 0; transform: translateY(-20px); }
      }
    </style>
  </head>

  <body class="overflow-hidden">
    <div class="fixed bottom-4 left-4 h-1/2 w-[320px]">
      <ul id="chat" class="flex flex-col-reverse gap-1 text-sm h-full overflow-hidden"></ul>
    </div>

    <script type="module">
      const chat = document.getElementById("chat");
      const HISTORY_LIMIT = 50;

      const addMsg = ({ platform, user, text, color, badges = [] }) => {
        const li = document.createElement("li");
        li.className =
          "px-3 py-1.5 rounded-md text-sm w-full break-words shadow-lg backdrop-blur-sm text-white border-l-4";
        li.style.background = "rgba(0, 0, 0, 0.6)";
        li.style.borderColor = platform === "twitch" ? "#9146FF" : "#FF0000";

        const usernameColor = platform === "twitch" && color ? color : "#FF4F4F";
        const iconHtml = badges
          .map(b =>
            b.startsWith("http")
              ? `<img src="${b}" class="inline h-4 w-4 mr-1 align-text-bottom" />`
              : `<span class="mr-1">${b}</span>`
          )
          .join("");

        li.innerHTML =
          `${iconHtml}<span style="color:${usernameColor}; text-shadow:0 0 2px black" class="font-bold">${user}:</span> ${text}`;

        chat.prepend(li);

        setTimeout(() => li.classList.add("fade-out"), 24_000);
        setTimeout(() => li.remove(), 24_500);

        while (chat.children.length > HISTORY_LIMIT) chat.lastChild.remove();
      };

      let ws;
      const connect = () => {
        ws = new WebSocket(`ws://${location.host}`);
        ws.onmessage = (ev) => {
          const payload = JSON.parse(ev.data);
          Array.isArray(payload) ? payload.forEach(addMsg) : addMsg(payload);
        };
        ws.onclose = () => setTimeout(connect, 3000);
        ws.onerror  = () => ws.close();
      };
      connect();
    </script>
  </body>
</html>
